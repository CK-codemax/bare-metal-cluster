---
- name: Join additional master nodes
  hosts: masters:!master1
  become: yes
  gather_facts: yes
  serial: 1

  tasks:
    - name: Reset kubeadm (clean previous state)
      command: kubeadm reset -f
      register: kubeadm_reset
      failed_when: false
      changed_when: false

    - name: Display kubeadm reset output
      debug:
        msg: "{{ kubeadm_reset.stdout_lines }}"
      when: kubeadm_reset.stdout_lines is defined

    - name: Generate certificate key on master1
      shell: |
        kubeadm init phase upload-certs --upload-certs 2>&1 \
          | grep -Eo '[A-Za-z0-9]{32,}' \
          | tail -n1
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      delegate_to: master1
      run_once: true
      register: cert_key

    - name: Ensure certificate key was obtained
      assert:
        that:
          - cert_key.stdout is defined
          - cert_key.stdout | length > 0
        fail_msg: "Failed to obtain certificate key from 'kubeadm init phase upload-certs --upload-certs' on master1. Check kubeadm version and permissions."
        success_msg: "Certificate key obtained."

    - name: Generate base join command on master1
      shell: |
        kubeadm token create --print-join-command
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      delegate_to: master1
      run_once: true
      register: join_command

    - name: Display master join command
      debug:
        msg: "{{ join_command.stdout }} --control-plane --certificate-key {{ cert_key.stdout }}"

    - name: Join master to control plane
      shell: "{{ join_command.stdout }} --control-plane --certificate-key {{ cert_key.stdout }}"
      register: master_join

    - name: Display master join output
      debug:
        var: master_join.stdout_lines

    - name: Wait for node to be Ready
      shell: kubectl get node {{ inventory_hostname }} --no-headers | awk '{print $2}'
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      delegate_to: master1
      register: node_status
      until: node_status.stdout == "Ready"
      retries: 30
      delay: 10


